---
applyTo: 'modules/home/nixvim/**/*lazyvim*.nix'
---

# LazyVim + NixVim Configuration Guide

## Architecture Overview

This setup uses a **hybrid approach** combining NixVim (declarative) with LazyVim (dynamic). This is important as the user wants to have a flexbile Neovim setup where they can easily add/remove plugins without needing to rebuild their entire NixOS configuration.

- **NixVim** manages the base Neovim configuration at `~/.config/nvim/` (read-only, generated from Nix)
- **LazyVim** provides the plugin ecosystem and sensible defaults
- **`~/.config/nvim-local/`** provides a writable directory for dynamic plugin management

### Why `nvim-local` instead of standard `~/.config/nvim/lua/plugins/`?

According to [LazyVim docs](https://www.lazyvim.org/configuration), user plugins should go in `~/.config/nvim/lua/plugins/`. However, we can't use this because:

`~/.config/nvim/` is **read-only** and generated by NixOS on every rebuild. Any manual changes to `~/.config/nvim/lua/plugins/` would be **wiped out** on rebuild.

## Directory Structure

```
~/.config/nvim/              # NixVim-generated (read-only)
└── init.lua                 # Generated from lazyvim.nix

~/.config/nvim-local/        # Writable runtime config
└── lua/
    └── user/
        └── specs/
            ├── init.lua       # Aggregates all spec files
            └── keymaps.lua    # Your custom keymaps and plugin specs
```

## Critical Fix Applied

**Issue:** The original `lazyvim.nix` was not following the official LazyVim starter pattern.

**Was:**
```lua
{
  "LazyVim/LazyVim",
  priority = 10000,
  lazy = false,
  opts = {},
},
{ import = "lazyvim.plugins" },  -- Separate import
```

**Now (correct):**
```lua
{ "LazyVim/LazyVim", import = "lazyvim.plugins" }  -- Combined as per starter
```

This aligns with the [official LazyVim starter](https://github.com/LazyVim/starter) structure.

## Architecture Analysis vs Official Starter

### Official LazyVim Starter Structure
```
~/.config/nvim/
├── init.lua                    # Bootstraps config.lazy
├── lua/
│   ├── config/
│   │   ├── lazy.lua           # Sets up lazy.nvim & spec imports
│   │   ├── autocmds.lua       # Custom autocommands
│   │   ├── keymaps.lua        # Custom keymaps
│   │   └── options.lua        # Vim options
│   └── plugins/
│       └── example.lua        # Plugin specs (auto-imported)
```

### Our NixVim Hybrid Structure
```
~/.config/nvim/                 # NixVim-generated (read-only)
└── init.lua                    # Generated from lazyvim.nix

~/.config/nvim-local/           # Writable runtime config
└── lua/
    └── user/
        └── specs/
            ├── init.lua        # Aggregates all spec files
            └── keymaps.lua     # Plugin specs (equivalent to plugins/*.lua)
```

### Key Differences & Rationale

1. **No `lua/config/` directory needed**: 
   - NixVim already handles autocmds, keymaps, and options declaratively
   - LazyVim's config files are for users who manage everything with lazy.nvim
   - We only need plugin specs, not the full config structure

2. **`user.specs` instead of `plugins` import**:
   - Official: `{ import = "plugins" }` auto-loads `lua/plugins/*.lua`
   - Ours: `{ import = "user.specs" }` loads `lua/user/specs/init.lua`
   - Why: Clearer separation between NixVim (base) and user runtime additions

3. **init.lua aggregator pattern**:
   - Official: lazy.nvim auto-discovers all files in `plugins/` directory
   - Ours: explicit aggregation via `init.lua` pcall loop
   - Why: More control over load order and easier debugging

### Correctness Verification

✅ **LazyVim Plugin Spec**: Correctly follows official pattern
```lua
{ "LazyVim/LazyVim", import = "lazyvim.plugins" }  -- ✓ Combined import
```

✅ **Lazy.nvim Setup**: Matches official structure
```lua
require("lazy").setup({
  spec = specs,
  defaults = { lazy = false, version = false },
  -- ...
})
```

✅ **Runtime Path Management**: Properly prepends writable directory
```lua
vim.opt.rtp:prepend("~/.config/nvim-local")
```

✅ **Conditional Import**: Safely checks for user specs before importing
```lua
if has_files then
  table.insert(specs, { import = "user.specs" })
end
```

### Conclusion

The structure is **correctly adapted** for a NixVim + LazyVim hybrid setup. It's not a 1:1 match with the official starter because:
- We don't need `lua/config/` (NixVim handles that)
- We use a custom namespace (`user.specs`) for clarity
- We use explicit aggregation instead of lazy.nvim's auto-discovery

This is **intentional** and **appropriate** for our use case.

## Testing

Verify specs are loading:
```bash
nvim --headless +"lua vim.opt.rtp:prepend(vim.fn.expand('~/.config/nvim-local')); local specs = require('user.specs'); print('Total specs:', #specs)" +qall
```
